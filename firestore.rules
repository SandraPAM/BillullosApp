rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow users to read and write their own 'budgets' documents.
    match /budgets/{budgetId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;

      // Allow create only if the user is creating a budget for themselves
      // and provides all the required, correctly-formatted fields.
      allow create: if request.auth != null &&
                      request.auth.uid == request.resource.data.userId &&
                      request.resource.data.name is string &&
                      request.resource.data.name.size() > 0 &&
                      request.resource.data.amount is number &&
                      request.resource.data.amount > 0 &&
                      request.resource.data.deadline is timestamp && // Correctly check for timestamp
                      request.resource.data.spentAmount == 0 &&
                      request.resource.data.createdAt == request.time;

      // Allow users to update their own budgets.
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Allow users to delete their own budgets.
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Default deny all other reads and writes
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
